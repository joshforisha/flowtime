<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="object-src 'none'; script-src 'unsafe-inline' 'self'" />
    <meta name="description" content="A very simple interface for managing Flowtime tasks" />
    <meta name="msapplication-TileColor" content="#DA532C" />
    <meta name="theme-color" content="#5E81AC" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <title>Flowtime</title>
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="icon" href="./icon-16.png" sizes="16x16" />
    <link rel="icon" href="./icon-32.png" sizes="32x32" />
    <link rel="manifest" href="./manifest.json" />
    <link rel="mask-icon" href="./safari-pinned-tab.svg" color="#4C566A" />
    <style>
      :root {
        font-size: 18px;
        line-height: 1.5;

        /* Nord Colors */
        --nord0: #2e3440;
        --nord1: #3b4252;
        --nord2: #434c5e;
        --nord3: #4c566a;
        --nord4: #d8dee9;
        --nord5: #e5e9f0;
        --nord6: #eceff4;
        --nord7: #8fbcbb;
        --nord8: #88c0d0;
        --nord9: #81a1c1;
        --nordA: #5e81ac;
        --nordB: #bf616a;
        --nordC: #d08770;
        --nordD: #ebcb8b;
        --nordE: #a3be8c;
        --nordF: #b48ead;

        /* Fonts */
        --sans-serif-fonts: -apple-system, BlinkMacSystemFont, avenir next, avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        background-color: var(--nord0);
        color: var(--nord4);
        font-family: var(--sans-serif-fonts);
        font-weight: 400;
        margin: 0 auto;
        padding: 20px;
      }

      button {
        align-items: center;
        background-color: var(--nord4);
        border-radius: 50%;
        border-width: 0;
        color: var(--nord2);
        cursor: pointer;
        display: inline-flex;
        flex-shrink: 0;
        font-family: inherit;
        font-size: 1.25em;
        font-weight: 500;
        justify-content: center;
        line-height: 1;
        min-height: 52px;
        min-width: 52px;
        transition: all 100ms ease-out;
        transition-property: background-color, color, opacity;
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.25;
      }

      button[data-action="clear"] {
        background-color: var(--nordC);
      }

      button[data-action="complete"] {
        background-color: var(--nordE);
      }

      button[data-action="create"] {
        background-color: var(--nord9);
      }

      button[data-action="delete"] {
        background-color: var(--nordB);
        color: var(--nord4);
      }

      button[data-action="move"] {
        cursor: grab;
        margin: 0 10px;
      }

      button[data-action="move"] {
        background-color: var(--nord6);
      }

      button[data-action="start"] {
        background-color: var(--nordD);
      }

      button[data-action="start"]:disabled {
        opacity: 0;
        pointer-events: none;
      }

      input[type="text"] {
        background-color: transparent;
        border: none;
        border-radius: 2px;
        color: inherit;
        font: inherit;
        margin-left: 10px;
        outline: 1px solid var(--nord9);
        padding: 0 5px;
        transition: outline 100ms ease-out;
        width: 100%;
      }

      input[type="text"]:focus {
        outline-color: var(--nord8);
      }

      li {
        border-radius: 5px;
        display: flex;
        margin: 1rem 0;
      }

      li.-completed input[type="text"] {
        color: var(--nord3);
      }

      li button[data-action="complete"] {
        display: none;
      }

      li.-active button[data-action="complete"] {
        display: flex;
      }

      li.-active button[data-action="start"],
      li.-completed button[data-action="start"] {
        display: none;
      }

      li.-active input[type="text"] {
        color: var(--nordD);
      }

      li.-active .timer {
        color: var(--nordD);
        opacity: 0.75;
      }

      li.-completed button[data-action="complete"] {
        display: flex;
        opacity: 0;
        pointer-events: none;
      }

      li.-completed .timer {
        color: inherit;
        opacity: 0.25;
      }

      ul {
        list-style-type: none;
        margin: 0 auto;
        max-width: 30rem;
        padding-left: 0;
      }

      .timer {
        align-items: center;
        display: inline-flex;
        justify-content: flex-start;
        opacity: 0;
        padding: 0 10px;
        transition: opacity 100ms ease-out;
        width: 4rem;
      }

      .timer::after {
        content: "m";
      }

      #Controls {
        display: flex;
        justify-content: center;
        margin: 4rem 0 2rem;
      }

      #Controls button {
        margin: 0 10px;
      }

      #Break {
        align-items: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        left: 0;
        opacity: 0;
        pointer-events: none;
        position: relative;
        top: 0;
        transition: opacity 250ms ease-out;
        width: 100%;
      }

      #Break.-active {
        opacity: 1;
        pointer-events: auto;
      }

      #BreakProgress {
        background-color: var(--nord4);
        height: 100%;
        width: 0;
      }

      #BreakProgressBar {
        border: 2px solid var(--nord4);
        border-radius: 5px;
        height: 10px;
        margin-top: 10px;
        max-width: 20rem;
        overflow: hidden;
        width: 90vw;
      }

      #BreakTime {
        height: 3rem;
        margin: 0;
      }

      @media screen and (min-width: 768px) {
        :root {
          font-size: 20px;
        }
      }

      @media screen and (min-width: 1024px) {
        :root {
          font-size: 22px;
        }
      }

      @media screen and (min-width: 1440px) {
        :root {
          font-size: 24px;
        }
      }

      @media screen and (hover: hover) {
        button {
          opacity: 0.9;
          transition: opacity 100ms ease-out;
        }

        button[data-action="delete"],
        button[data-action="move"] {
          opacity: 0;
        }

        button:not(:disabled):hover {
          opacity: 1 !important;
        }

        input[type="text"] {
          outline-color: transparent;
        }

        input[type="text"]:not(:disabled):not(:focus):hover {
          outline-color: var(--nord9);
        }

        li:hover button[data-action="delete"],
        li:hover button[data-action="move"] {
          opacity: 0.9;
        }
      }
    </style>
  </head>
  <body>
    <div id="Break">
      <h1 id="BreakTime"></h1>
      <div id="BreakProgressBar">
        <div id="BreakProgress"></div>
      </div>
    </div>
    <ul id="TaskList"></ul>
    <div id="Controls">
      <button data-action="create" title="Add task (shortcut: A)">&plus;</button>
      <button data-action="clear" title="Clear tasks">&times;</button>
    </div>
    <audio id="Chime">
      <source src="chime.wav" type="audio/wav" />
    </audio>
    <script>
      const emptyState = {
        activeTaskId: undefined,
        startedTime: undefined,
        tasks: []
      };

      if (window.localStorage.getItem('version') !== '3') {
        window.localStorage.clear();
        window.localStorage.setItem('version', '3');
        window.localStorage.setItem('state', JSON.stringify(emptyState));
      }

      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      const breakContainer = $('#Break');
      const breakProgress = $('#BreakProgress');
      const breakTime = $('#BreakTime');
      const chimeAudio = $('#Chime');
      const taskList = $('#TaskList');

      let breaking = false;
      let draggingItem;
      let state = JSON.parse(window.localStorage.getItem('state')) || emptyState;
      let timerInterval = null;
      let timerTimeout = null;

      function addTask() {
        const task = {
          id: Date.now().toString(),
          name: ''
        };
        const taskItem = makeTaskItem(task);
        taskList.appendChild(taskItem);
        taskItem.querySelector('input').focus();
        updateState({ tasks: state.tasks.concat(task) });
      }

      function breakMinutes(minutesSpent) {
        if (minutesSpent <= 4) return 1;
        if (minutesSpent <= 25) return 5;
        if (minutesSpent <= 50) return 8;
        if (minutesSpent <= 90) return 10;
        return 15;
      }

      function disable(button) {
        if (!button.hasAttribute('disabled')) {
          button.setAttribute('disabled', '');
        }
      }

      function enable(button) {
        if (button.hasAttribute('disabled')) {
          button.removeAttribute('disabled');
        }
      }

      function enableTasks() {
        for (const button of $$('li:not(.-active) button[data-action="start"]')) {
          enable(button);
        }
      }

      function findTaskIndex (item) {
        for (let i in taskList.children) {
          if (taskList.children.item(i) === item) return i;
        }
      }

      function h(def, options = {}) {
        if (Array.isArray(options)) options = { children: options };
        const { actions, attributes, children, classes, textContent } = options;
        const [type, ...inlineClasses] = def.split('.');
        const element = document.createElement(type);
        if (attributes) {
          for (const [key, value] of Object.entries(attributes)) {
            if (value !== undefined) element.setAttribute(key, value);
          }
        }
        if (inlineClasses.length > 0) element.classList.add(...inlineClasses);
        if (classes) element.classList.add(...classes.filter(c => c));
        if (textContent) element.textContent = textContent;
        if (children) {
          for (const child of children) {
            if (child) element.appendChild(child);
          }
        }
        if (actions) {
          for (const [eventType, handler] of Object.entries(actions)) {
            element.addEventListener(eventType, event => handler(event, element));
          }
        }
        return element;
      }

      function makeTaskItem(task) {
        return h('li', {
          actions: {
            dragover: (event, item) => {
              event.preventDefault();
              if (item === draggingItem) return;
              const src = findTaskIndex(draggingItem);
              const dest = findTaskIndex(item);
              if (dest < src) return taskList.insertBefore(draggingItem, item);
              if (dest === taskList.children.length - 1) return todoList.appendChild(draggingItem);
              taskList.insertBefore(draggingItem, taskList.children.item(dest + 1));
            },
            dragstart: (event, item) => {
              draggingItem = item;
            }
          },
          attributes: {
            'data-id': task.id
          },
          children: [
            h('button', {
              actions: {
                click: (event) => {
                  if (state.activeTaskId !== undefined) return;
                  for (const button of $$('button[data-action="start"]')) {
                    disable(button);
                  }
                  event.target.parentNode.classList.add('-active');
                  updateState({
                    activeTaskId: task.id,
                    startedTime: Date.now()
                  });
                  startCounting();
                }
              },
              attributes: {
                'data-action': 'start',
                disabled: (state.activeTaskId && state.activeTaskId !== task.id || breaking) ? '' : undefined,
                title: 'Start'
              },
              textContent: 'ᐅ'
            }),
            h('button', {
              actions: {
                click: (event) => {
                  stopCounting();
                  event.target.parentNode.classList.add('-completed');
                  event.target.parentNode.classList.remove('-active');
                  const duration = Math.max(1, Math.ceil((Date.now() - state.startedTime) / 60000));
                  updateState({
                    activeTaskId: undefined,
                    startedTime: undefined,
                    tasks: state.tasks.map(t => t.id === task.id ? { ...t, duration } : t)
                  });
                  startBreak(duration);
                }
              },
              attributes: {
                'data-action': 'complete',
                title: 'Complete'
              },
              textContent: '✓'
            }),
            h('span.timer', {
              textContent: task.duration
            }),
            h('input', {
              actions: {
                input: (event) => {
                  updateTask({ ...task, name: event.target.value });
                },
                keydown: (event) => {
                  if (event.key === 'Enter') {
                    event.preventDefault();
                    return event.target.blur();
                  }
                }
              },
              attributes: {
                disabled: typeof task.duration !== 'undefined' ? '' : undefined,
                type: 'text',
                value: task.name
              }
            }),
            h('button', {
              actions: {
                mousedown: (event) => {
                  event.target.parentNode.setAttribute('draggable', 'true');
                }
              },
              attributes: {
                'data-action': 'move',
                title: 'Move'
              },
              textContent: '≡'
            }),
            h('button', {
              actions: {
                click: (event) => {
                  if (confirm('Are you sure?')) {
                    stopCounting();
                    const newState = {
                      tasks: state.tasks.filter(t => t.id !== task.id)
                    };
                    if (state.activeTaskId === task.id) {
                      newState.activeTaskId = null;
                      newState.startedTime = null;
                      enableTasks();
                    }
                    taskList.removeChild(event.target.parentNode);
                    updateState(newState);
                  }
                }
              },
              attributes: {
                'data-action': 'delete',
                title: 'Delete'
              },
              textContent: '×'
            })
          ],
          classes: [
            state.activeTaskId === task.id ? '-active' : null,
            typeof task.duration !== 'undefined' ? '-completed' : null
          ]
        });
      }

      function startCounting() {
        const taskItem = $('li.-active');
        const timer = taskItem.querySelector('.timer');
        const updateCount = () => {
          const elapsed = Math.ceil((Date.now() - state.startedTime) / 60000);
          timer.textContent = Math.max(1, elapsed).toString();
        };
        updateCount();
        const currentMs = Date.now() % 60000;
        const taskOffset = state.startedTime % 60000;
        const delay = currentMs > taskOffset
          ? 60000 + taskOffset - currentMs
          : taskOffset - currentMs;
        timerTimeout = setTimeout(() => {
          updateCount();
          timerTimeout = null;
          timerInterval = setInterval(updateCount, 60000);
        }, delay);
      }

      function startBreak(minutesSpent) {
        breaking = true;
        const breakMs = breakMinutes(minutesSpent) * 60000;
        const start = Date.now();
        let remainingSeconds = Math.ceil(breakMs / 1000);
        breakTime.textContent = remainingSeconds;
        breakProgress.style.width = '0%';
        breakContainer.classList.add('-active');
        const countdown = setInterval(() => {
          const elapsedMs = Date.now() - start;
          remainingSeconds = Math.ceil((breakMs - elapsedMs) / 1000);
          breakTime.textContent = remainingSeconds;
          breakProgress.style.width = `${100 * elapsedMs / breakMs}%`;
          if (breaking && elapsedMs >= (breakMs - 250)) {
            breakContainer.classList.remove('-active');
            breaking = false;
            for (const button of $$('button[data-action="start"]')) {
              enable(button);
            }
          }
          if (elapsedMs >= breakMs) {
            chimeAudio.play();
            clearInterval(countdown);
          }
        }, 250);
      }

      function stopCounting() {
        if (timerTimeout) {
          clearTimeout(timerTimeout);
          timerTimeout = undefined;
        }
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = undefined;
        }
      }

      function updateState(changes) {
        if (changes) {
          state = { ...state, ...changes };
          for (const [key, value] of state) {
            if (value === null) deletestate[key];
          }
        }
        window.localStorage.setItem('state', JSON.stringify(state))
      }

      function updateTask(task) {
        updateState({
          tasks: state.tasks.map(t => t.id === task.id ? task : t)
        });
      }

      window.addEventListener('dragend', () => {
        updateState({
          tasks: Array.from(taskList.children).map((item) =>
            state.tasks.find(t => t.id === item.getAttribute('data-id'))
          )
        });
        draggingItem.removeAttribute('draggable');
        draggingItem = undefined;
      });

      window.addEventListener('keydown', (event) => {
        if (event.target === document.body && event.key === 'a') {
          event.preventDefault();
          addTask();
        }
      });

      $('button[data-action="clear"]').addEventListener('click', () => {
        if (confirm('Clear all tasks?')) {
          taskList.innerHTML = '';
          updateState(emptyState);
        }
      });

      $('button[data-action="create"]').addEventListener('click', () => {
        addTask();
      });

      for (const task of state.tasks) {
        taskList.appendChild(makeTaskItem(task));
      }

      if (state.activeTaskId) {
        startCounting();
      }
    </script>
  </body>
</html>
